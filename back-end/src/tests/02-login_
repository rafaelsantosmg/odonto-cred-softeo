import * as sinon from 'sinon';
import * as chai from 'chai';
import chaiHttp from 'chai-http';
import { describe, it, before, after } from 'mocha';

import api from '../api/api';
import User from '../database/models/user';
import { userFindOne } from './mocks/userMock';

import { Response } from 'superagent';

chai.use(chaiHttp);

const { expect } = chai;

let chaiHttpResponse: Response;

describe('Testa as rotas de Login', () => {
  describe('Testa a requisição da rota "/login"', () => {
    describe('Testa se a requisição de Login foi success', () => {
      before(async () => {
        sinon.stub(User, 'findOne').resolves(userFindOne as User);
      });

      after(() => {
        (User.findOne as sinon.SinonStub).restore();
      });

      it('Testa se login foi feito com sucesso!', async () => {
        chaiHttpResponse = await chai.request(api).post('/login').send({
          email: 'erika@odontocred.com.br',
          password: '--@65erika@99--',
        });

        expect(chaiHttpResponse.status).to.be.equal(200);
        expect(chaiHttpResponse.body).have.property('user');
        expect(chaiHttpResponse.body).have.property('token');
      });
    });

    describe('Testa se a requisição foi feita com dados inválidos', () => {
      before(async () => {
        sinon.stub(User, 'findOne').resolves(null);
      });

      after(() => {
        (User.findOne as sinon.SinonStub).restore();
      });

      it('Testa se usuario é not found e status é 400', async () => {
        chaiHttpResponse = await chai
          .request(api)
          .post('/login')
          .send({ email: 'an@admin.com', password: '--@65erika@99--' });

        expect(chaiHttpResponse.status).to.be.equal(401);
      });

      it('Testa se password é incorrect e status é 400', async () => {
        chaiHttpResponse = await chai
          .request(api)
          .post('/login')
          .send({ email: 'erika@odontocred.com.br', password: 'admin' });

        expect(chaiHttpResponse.status).to.be.equal(401);
      });

      it('Testa se não for passado email o status é 401', async () => {
        chaiHttpResponse = await chai
          .request(api)
          .post('/login')
          .send({ password: 'admin' });

        expect(chaiHttpResponse.status).to.be.equal(400);
      });

      it('Testa se não for passado password o status é 401', async () => {
        chaiHttpResponse = await chai
          .request(api)
          .post('/login')
          .send({ email: 'erika@odontocred.com.br' });

        expect(chaiHttpResponse.status).to.be.equal(400);
      });
    });
  });
});
